This document is a work in progress, do not follow it yet!

##Upgrading gitlab

New versions are released on the 22 of each month. 
See the upgrade documentation here https://github.com/gitlabhq/gitlabhq/tree/master/doc/update


#Before upgrade

stop gitlab
stop nginx
stop database
backup database

checkout the new branches of git
cd /home/git/gitlab/
git checkout -b 6-1-stable origin/6-1-stable

**Make sure to run a git status after switching branches**
http://stackoverflow.com/questions/19070744/upgrading-gitlab-gives-following-error-dont-know-how-to-build-task-migrate-ii/19070762#19070762


*compare the old init script to the new init script*  

    git diff 6-0-stable 6-1-stable --lib/support/init.d/gitlab

If they are different, then save the new one to templates/gitalb.init.6.x.erb (where x is the new release)
There are no variables in the init script


*compare the old config/gitlab.yml to the new config/gitlab.yml*  

    git difftool 6-0-stable 6-1-stable --config/gitlab.yml.example  
    
If they are different, then create a new template with the release number by coping the currently working one (templates/gitlab.yml.6.x.erb )
Update the variables as appropriate

*compare the old gitlab-shell/config.yml to the new config*


*compare the old unicorn.rb.example*

    git diff 6-2-stable 6-1-stable -- config/unicorn.rb.example  
    
cp config/unicorn.rb.example ../gitlab/templates/unicorn.rb.6-2-stable.erb

*compare the old database setup script 

    git diff 6-2-stable 6-1-stable --config/database.yml.mysql  
    
If they are different, then create a new database.6-x-stable.erb file
Update the variables as appropriate



#Upgrade


When running rake commands, apped '--trace' to the end to see addional information

#instead of this
sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production

#run this
sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production --trace


Follow the install guide until you reach the step to update your config files. 
Instead of manually updating the config files, change the puppet git_branch parameter to the new version of gitlab

     gitlab_branch          => '6-2-stable',


Do not manually update the init script, it will be updated at the next puppet run

Check the application status

    cd /home/git/gitlab
    sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production
    sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production


Execute a puppet apply with the --noop flag

If all looks well, run the puppet apply again without the --noop flag


#Post upgrade

- Verify the ssl certificate permissions
- Verify the custom thumbnail icons permission